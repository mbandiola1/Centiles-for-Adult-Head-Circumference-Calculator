<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adult Head Circumference Tool (Centile Chart with Documentation)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        /* Chart specific styles */
        
        .axis text { font-size: 11px; }
        .axis line { stroke: #ccc; }
        .axis path { stroke: #ccc; }

        /* Style for the gridlines */
        .grid line {
            stroke: #d1d5db; /* Slightly darker gray for better visibility */
            shape-rendering: crispEdges;
        }
        .grid path {
            stroke-width: 0;
        }
        
        /* Style for the 'X' marker */
        #subject-marker {
            transition: opacity 0.5s;
        }
        #subject-marker .line {
            /* Now uses bright red and thick stroke */
            stroke: #ef4444; 
            stroke-width: 4; 
            stroke-linecap: round;
        }
        /* Style for the intersection lines */
        /* Removed stroke definition here to force it in JS, but kept dasharray */
        .intersection-line {
            stroke-dasharray: 4, 2;
            transition: opacity 0.5s;
        }
        
        /* Style for the background box behind the subject label */
        .label-bg {
            fill: rgba(255, 255, 255, 0.85); /* Semi-translucent white */
            stroke: #ef4444; /* Red border */
            stroke-width: 1;
            rx: 3; /* Rounded corners */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">

    <div id="app" class="w-full max-w-4xl">

        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-2">
            Adult Head Circumference Centile Tool
        </h1>
        <p class="text-center text-sm text-gray-500 mb-1">
            Calculation and Centile Chart based on 
            <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC1793909/" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline font-semibold">
                Bushby et al. (1992) Centiles for adult head circumference.
            </a>
        </p>
        <p class="text-center text-xs text-red-600 mb-8 font-semibold p-1 border border-red-200 bg-red-50 rounded-lg max-w-lg mx-auto">
            Disclaimer: This tool is for reference only and does not provide a definitive clinical diagnosis.
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-100 h-full">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-6 border-b pb-3">Input Measurements</h2>
                
                <form id="circumference-form" class="space-y-6">
                    
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <select id="gender" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 gap-6">
                        <div id="height-input-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Height</label>
                            <div class="flex space-x-3">
                                <input type="number" step="1" id="height-ft" min="4" max="7" placeholder="Feet (e.g., 5)" class="block w-1/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                                <input type="number" step="0.1" id="height-in" min="0" max="11.9" placeholder="Inches (e.g., 9)" class="block w-1/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                                <input type="number" step="0.1" id="height-cm" min="140" max="200" placeholder="cm (e.g., 175.5)" class="block w-1/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Enter height in Ft/In or cm. Fields will auto-convert. Range: 140-200 cm.</p>
                        </div>
                        
                        <div>
                            <label for="circumference" class="block text-sm font-medium text-gray-700 mb-1">Head Circumference (cm)</label>
                            <input type="number" step="0.1" id="circumference" min="40" max="70" placeholder="e.g., 57.0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border" required>
                        </div>
                    </div>

                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Calculate & Plot
                    </button>
                </form>
            </div>

            <div class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-100 flex flex-col justify-between">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-3">Centile Chart</h2>
                <div id="chart-container" class="w-full" style="min-height: 350px;">
                    <p id="chart-message" class="text-center text-gray-500 mt-16">Enter measurements above to generate the centile chart.</p>
                </div>
            </div>
        </div>

        <div id="results" class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-100 mt-8 hidden">
            <h2 class="text-2xl font-semibold text-green-700 mb-6 border-b pb-3">Calculated Metrics</h2>
            
            <div class="space-y-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
                
                <div class="p-3 bg-gray-50 rounded-lg">
                    <span class="block text-sm font-medium text-gray-700">Expected Mean HC (Mean):</span>
                    <span id="mean-output" class="text-xl font-bold text-gray-800">--</span>
                </div>
                
                <div class="p-4 bg-indigo-100 rounded-lg">
                    <span class="block text-sm font-medium text-indigo-800">Calculated Z-Score:</span>
                    <span id="z-score-output" class="text-2xl font-extrabold text-indigo-800">--</span>
                </div>
                
                <div class="p-3 bg-gray-50 rounded-lg">
                    <span class="block text-sm font-medium text-gray-700">Percentile Rank:</span>
                    <span id="percentile-output" class="text-xl font-bold text-gray-800">--</span>
                </div>

                <div class="p-4 rounded-lg" id="interpretation-box">
                    <h3 class="text-base font-bold text-gray-800 mb-1">Interpretation:</h3>
                    <p id="interpretation-output" class="text-md font-semibold text-gray-800">--</p>
                </div>
            </div>
        </div>
        
        <div id="error-message" class="hidden mt-4 p-4 text-sm font-medium text-red-800 rounded-lg bg-red-50 border border-red-200" role="alert">
            </div>

        <div class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-100 mt-8">
            <button id="toggle-methodology" class="w-full py-3 px-4 rounded-lg text-left font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150 ease-in-out flex justify-between items-center">
                <span>Show Methodology & Documentation</span>
                <span id="toggle-icon">+</span>
            </button>
            <div id="methodology-content" class="mt-4 p-4 border border-gray-200 rounded-lg hidden text-sm">
                <h3 class="text-lg font-bold mb-3">Methodology Report: Adult Head Circumference Centile Tool</h3>
                
                <p class="mb-3">This document outlines the statistical methodology and specific formulas used within the interactive web application for calculating adult head circumference (HC) Z-scores and centiles.</p>
                <p class="mb-6">The tool is based entirely on the linear regression model published in the study: <strong>Centiles for adult head circumference</strong> by Bushby et al. (1992).</p>

                <h4 class="text-base font-semibold mb-2 border-b">I. Core Statistical Model</h4>
                <p>The Bushby et al. study found that adult head circumference is primarily correlated with <strong>stature (height)</strong>, not age. The calculation relies on three confirmed parameters extracted from the paper:</p>
                
                <ol class="list-decimal pl-6 space-y-1 mb-4">
                    <li><strong>Expected Mean Head Circumference (Mean):</strong> A gender-specific linear regression equation based on the subject's height.</li>
                    <li><strong>Standard Deviation (SD):</strong> A constant measure of scatter around the mean line (SD = 1.41 cm).</li>
                    <li><strong>Z-Score:</strong> The number of standard deviations the subject's measurement falls above or below the mean.</li>
                </ol>
                
                <p class="mb-4">The specific parameters used in the regression equations are: Height Slope (0.08673), Male Intercept (42.4), and Female Intercept (41.02).</p>

                <h4 class="text-base font-semibold mb-2 border-b">II. The Calculation Steps</h4>

                <p class="font-bold">Step 1: Calculate the Expected Mean HC (Mean)</p>
                <p>The mean head circumference (Mean) is the expected HC for a person of a specific gender and height:</p>
                <p class="font-mono bg-gray-100 p-2 rounded-md">Males: Mean = 42.4 + (0.08673 &times; Height in cm)</p>
                <p class="font-mono bg-gray-100 mb-4 p-2 rounded-md">Females: Mean = 41.02 + (0.08673 &times; Height in cm)</p>

                <p class="font-bold">Step 2: Calculate the Z-Score</p>
                <p>The Z-Score (Z) determines how far the measured HC is from the expected mean, standardized by the Standard Deviation (SD = 1.41 cm):</p>
                <p class="font-mono bg-gray-100 mb-4 p-2 rounded-md">Z = (Measured HC - Mean) / SD</p>

                <p class="font-bold">Step 3: Calculate the Centile Rank</p>
                <p class="mb-4">The centile rank (percentile) is derived by converting the Z-score using the Cumulative Distribution Function (CDF) of the standard normal distribution.</p>

                <h4 class="text-base font-semibold mb-2 border-b">III. Interpretation Thresholds</h4>
                <p class="mb-2">The thresholds below are used to provide the interpretation text and color-coding in the results box:</p>
                <ul class="list-disc pl-6 space-y-1">
                    <li><strong>Z &gt; +3.0 SD:</strong> Head circumference is extremely large for stature. (Red)</li>
                    <li><strong>Z &gt; +2.0 to &le; +3.0 SD:</strong> Head circumference is large for stature. (Red)</li>
                    <li><strong>Z &gt; +1.5 to &le; +2.0 SD:</strong> Head circumference is above the expected average. (Yellow)</li>
                    <li><strong>Z = -1.5 to Z = +1.5 SD:</strong> Head circumference is within the expected average range. (Green)</li>
                    <li><strong>Z &lt; -1.5 to &ge; -2.0 SD:</strong> Head circumference is below the expected average. (Yellow)</li>
                    <li><strong>Z &lt; -2.0 SD:</strong> Head circumference is significantly small for stature. (Red)</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('circumference-form');
            const resultsDiv = document.getElementById('results');
            const errorMessageDiv = document.getElementById('error-message');
            const chartContainer = document.getElementById('chart-container');
            
            // --- TWEAK 1: Get references to height inputs ---
            const heightFtInput = document.getElementById('height-ft');
            const heightInInput = document.getElementById('height-in');
            const heightCmInput = document.getElementById('height-cm');
            
            // --- CONSTANTS ---
            const SD = 1.41; 
            const SLOPE = 0.08673;
            const INTERCEPTS = { male: 42.4, female: 41.02 };
            // Z-scores for common percentiles
            const Z_SCORES = { 3: -1.88, 10: -1.28, 25: -0.67, 50: 0, 75: 0.67, 90: 1.28, 97: 1.88 };
            
            // Height conversion factors
            const CM_PER_FOOT = 30.48;
            const CM_PER_INCH = 2.54;
            
            // --- TWEAK 1: Flag to prevent conversion loops ---
            let isConverting = false;

            // --- CHART SETUP ---
            let svg, xScale, yScale;
            const margin = { top: 20, right: 25, bottom: 40, left: 50 };
            let width, height;

            // Helper function to create D3 gridlines
            function makeXGridlines() { return d3.axisBottom(xScale).ticks(12); } // Ticks every 5cm
            function makeYGridlines() { return d3.axisLeft(yScale).ticks(13); } // Ticks every 1cm (50 to 63)

            function setupChart(gender) {
                // Clear previous chart and message
                chartContainer.innerHTML = '';
                
                const containerWidth = chartContainer.clientWidth;
                width = containerWidth - margin.left - margin.right;
                height = 400 - margin.top - margin.bottom;

                // 1. Scales (Chart ranges based on study and figures)
                const xMin = 140; 
                const xMax = 200; 
                const yMin = 50;
                const yMax = 63; 
                
                xScale = d3.scaleLinear().domain([xMin, xMax]).range([0, width]);
                yScale = d3.scaleLinear().domain([yMin, yMax]).range([height, 0]);

                // 2. SVG Container
                svg = d3.select("#chart-container")
                    .append("svg")
                    .attr("viewBox", `0 0 ${containerWidth} 400`)
                    .append("g")
                    .attr("transform", `translate(${margin.left}, ${margin.top})`);
                
                
                // 3. Gridlines (Draw gridlines first, so they are at the back)
                svg.append("g")			
                    .attr("class", "grid")
                    .attr("transform", `translate(0, ${height})`)
                    .call(makeXGridlines()
                        .tickSize(-height)
                        .tickFormat("")
                    );

                svg.append("g")			
                    .attr("class", "grid")
                    .call(makeYGridlines()
                        .tickSize(-width)
                        .tickFormat("")
                    );

                // 4. Centile Line Generator
                const lineGenerator = d3.line()
                    .x(d => xScale(d.height))
                    .y(d => yScale(d.hc));

                // 5. Generate Centile Data Points
                const centileData = Object.entries(Z_SCORES).map(([centile, z]) => {
                    const dataPoints = [];
                    // Generate points for every 1 cm within the chart range
                    for (let h = xMin; h <= xMax; h += 1) { 
                        const meanHC = INTERCEPTS[gender] + (SLOPE * h);
                        const hc = meanHC + (z * SD);
                        dataPoints.push({ height: h, hc: hc, centile: centile, z: z });
                    }
                    return dataPoints;
                });

                // 6. Draw Centile Lines (Fixed styling to match paper)
                centileData.forEach(data => {
                    const centile = parseInt(data[0].centile);
                    let strokeColor = '#1f2937'; // Dark gray/Black
                    let strokeDash;

                    // Centile line logic: broken (3, 25, 75, 97), continuous (10, 50, 90)
                    if (centile === 3 || centile === 25 || centile === 75 || centile === 97) {
                        strokeDash = '8, 4'; 
                    } else {
                        strokeDash = '0'; 
                    }

                    svg.append("path")
                        .datum(data)
                        .attr("d", lineGenerator)
                        .style("fill", "none")
                        .style("stroke", strokeColor)
                        .style("stroke-width", "2px")
                        .style("stroke-dasharray", strokeDash)
                        .attr("data-centile", centile);

                    // Centile Labels (at the end of the line)
                    svg.append("text")
                        .attr("x", xScale(xMax) + 4) 
                        .attr("y", yScale(data[data.length - 1].hc))
                        .attr("dy", "0.3em")
                        .attr("font-size", "10px")
                        .attr("font-weight", "bold")
                        .attr("fill", "#6b7280")
                        .text(centile);
                });


                // 7. Axes (Draw axes over the centile lines)
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", `translate(0, ${height})`)
                    .call(d3.axisBottom(xScale).ticks(12)) // Show more tick labels
                    .call(g => g.select(".domain").remove());
                
                svg.append("g")
                    .attr("class", "y axis")
                    .call(d3.axisLeft(yScale).ticks(13)) // Show more tick labels
                    .call(g => g.select(".domain").remove());

                // Axis Labels
                svg.append("text")
                    .attr("class", "text-sm text-gray-500")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + 35)
                    .text("Height (cm)");

                svg.append("text")
                    .attr("class", "text-sm text-gray-500")
                    .attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 15)
                    .attr("x", -height / 2)
                    .text("Head Circumference (cm)");
                    
                // 8. Add Group for Intersection Lines (This must be drawn before the marker group)
                svg.append("g").attr("id", "intersection-lines-group").attr("opacity", 0);


                // 9. Add Subject Marker Group (Rendered LAST to ensure visibility)
                const markerSize = 8;
                const markerGroup = svg.append("g")
                    .attr("id", "subject-marker-group")
                    .attr("opacity", 0);
                
                // Marker X
                const marker = markerGroup.append("g")
                    .attr("id", "subject-marker")
                    .attr("transform", "translate(0,0)");
                
                // Draw the 'X' lines
                marker.append("line").attr("class", "line")
                    .attr("x1", -markerSize).attr("y1", -markerSize)
                    .attr("x2", markerSize).attr("y2", markerSize);
                
                marker.append("line").attr("class", "line")
                    .attr("x1", -markerSize).attr("y1", markerSize)
                    .attr("x2", markerSize).attr("y2", -markerSize);

                // Label Background (Rect)
                markerGroup.append("rect")
                    .attr("id", "subject-label-bg")
                    .attr("class", "label-bg")
                    .attr("width", 1) // placeholder
                    .attr("height", 1) // placeholder
                    .attr("x", 0).attr("y", 0); // will be updated in plotSubject

                // Label Text (Drawn after rect)
                markerGroup.append("text")
                    .attr("id", "subject-label")
                    .attr("font-size", "12px")
                    .attr("font-weight", "bold")
                    .attr("fill", "#1f2937")
                    .attr("text-anchor", "middle");
            }
            
            // --- NEW FUNCTION: UPDATE ONLY INTERSECTION LINES (MAXIMUM Z-ORDER) ---
            function updateIntersectionLines(xPos, yPos, plotHeight) {
                const intersectionLinesGroup = d3.select("#intersection-lines-group");
                
                // Clear and redraw, forcing Z-order high
                intersectionLinesGroup.html(""); 

                // Vertical Line (Height) - Starts at X-axis (plotHeight) and goes up to the plotted point (yPos)
                intersectionLinesGroup.append("line")
                    .attr("class", "intersection-line")
                    .attr("x1", xPos).attr("y1", plotHeight) // Start at bottom axis line (plotHeight)
                    .attr("x2", xPos).attr("y2", yPos)       // End at plotted point
                    .style("stroke", "#ef4444") // FORCE RED
                    .style("stroke-width", 2); // Increased width for visibility
                
                // Horizontal Line (Circumference) - Starts at Y-axis (0) and goes right to the plotted point (xPos)
                intersectionLinesGroup.append("line")
                    .attr("class", "intersection-line")
                    .attr("x1", 0).attr("y1", yPos) // Start at left axis line (0)
                    .attr("x2", xPos).attr("y2", yPos) // End at plotted point
                    .style("stroke", "#ef4444") // FORCE RED
                    .style("stroke-width", 2); // Increased width for visibility

                intersectionLinesGroup.attr("opacity", 1);
            }

            // --- PLOTTING FUNCTION ---
            function plotSubject(heightValue, circumference, percentile) {
                const group = d3.select("#subject-marker-group");
                const label = d3.select("#subject-label");
                const labelBg = d3.select("#subject-label-bg");
                
                const xPos = xScale(heightValue);
                const yPos = yScale(circumference);
                
                // 1. Update Marker Position
                d3.select("#subject-marker").attr("transform", `translate(${xPos}, ${yPos})`);

                // 2. Update Intersection Lines (Crucial step moved to external function)
                // We must use the global 'height' variable here which stores the pixel coordinate of the X-axis
                updateIntersectionLines(xPos, yPos, height);

                // 3. Update Label and Background Position
                const labelText = `Your HC (${percentile.toFixed(1)}%)`;
                label.attr("x", xPos).attr("y", yPos - 18).text(labelText);
                
                // --- TWEAK 2: Use getBBox() for precise label background ---
                // Calculate text dimensions AFTER rendering the text
                const textBBox = label.node().getBBox();
                const textWidth = textBBox.width; 
                const textHeight = textBBox.height;
                const padding = 6;
                
                labelBg
                    .attr("x", textBBox.x - padding / 2)
                    .attr("y", textBBox.y - padding / 2)
                    .attr("width", textWidth + padding)
                    .attr("height", textHeight + padding)
                    .attr("opacity", 1);
                // --- End Tweak 2 ---


                // 4. Show all elements
                group.attr("opacity", 1);
            }
            

            // Initial chart setup to show the range (defaults to male lines)
            setupChart('male');

            // Handle window resize for responsiveness
            window.addEventListener('resize', () => {
                const currentGender = document.getElementById('gender').value || 'male';
                setupChart(currentGender);
                
                // If results are visible, replot the subject marker
                if (!resultsDiv.classList.contains('hidden')) {
                     const gender = document.getElementById('gender').value;
                     const heightValue = getValidatedHeightCm();
                     const circumference = parseFloat(document.getElementById('circumference').value);

                     if (heightValue && !isNaN(circumference)) {
                        const { percentile } = calculateCircumference(gender, heightValue, circumference);
                        plotSubject(heightValue, circumference, percentile);
                     }
                }
            });

            // --- HEIGHT CONVERSION AND VALIDATION ---

            // --- TWEAK 1: Function to convert cm to ft/in ---
            function convertCmToImperial(cm) {
                if (isConverting || isNaN(cm) || cm < 140 || cm > 200) {
                    if (isNaN(cm) || cm < 140 || cm > 200) {
                         // If cm is invalid or out of range, clear ft/in
                        isConverting = true;
                        heightFtInput.value = '';
                        heightInInput.value = '';
                        isConverting = false;
                    }
                    return;
                }
                isConverting = true;
                const totalInches = cm / CM_PER_INCH;
                const feet = Math.floor(totalInches / 12);
                const inches = (totalInches % 12).toFixed(1);
                
                heightFtInput.value = feet;
                heightInInput.value = inches;
                isConverting = false;
            }
            
            // --- TWEAK 1: Function to convert ft/in to cm ---
            function convertImperialToCm() {
                if (isConverting) return;
                isConverting = true;
                const ft = parseFloat(heightFtInput.value) || 0;
                const inches = parseFloat(heightInInput.value) || 0;
                
                if (ft === 0 && inches === 0) {
                     heightCmInput.value = '';
                     isConverting = false;
                     return;
                }
                
                const calculatedCm = (ft * CM_PER_FOOT) + (inches * CM_PER_INCH);
                
                if (calculatedCm >= 140 && calculatedCm <= 200) {
                    heightCmInput.value = calculatedCm.toFixed(1);
                } else {
                     heightCmInput.value = ''; // Clear if out of range
                }
                isConverting = false;
            }
            
            // --- TWEAK 1: Event listeners for height inputs ---
            heightCmInput.addEventListener('input', () => {
                convertCmToImperial(parseFloat(heightCmInput.value));
            });
            heightFtInput.addEventListener('input', convertImperialToCm);
            heightInInput.addEventListener('input', convertImperialToCm);


            /**
             * Gets the validated height in CM from the input fields.
             * @returns {number | null} Height in cm, or null if input is invalid.
             */
            function getValidatedHeightCm() {
                const cm = parseFloat(heightCmInput.value); // Use the cm input as the source of truth
                
                if (isNaN(cm) || cm < 140 || cm > 200) {
                    return null;
                }
                
                return cm;
            }


            // --- UTILITY FUNCTIONS ---
            function displayMessage(message, isError = false) {
                errorMessageDiv.classList.toggle('hidden', !isError);
                if (isError) {
                    errorMessageDiv.innerHTML = message;
                    resultsDiv.classList.add('hidden');
                } else {
                    errorMessageDiv.classList.add('hidden');
                }
            }

            // --- TWEAK 3: Refactor CDF calculation into its own function ---
            /**
             * Converts a Z-score to a percentile rank using a CDF approximation.
             * @param {number} zScore - The Z-score.
             * @returns {number} The percentile (0-100).
             */
            function zScoreToPercentile(zScore) {
                const b1 = 0.319381530;
                const b2 = -0.356563782;
                const b3 = 1.781477937;
                const b4 = -1.821255978;
                const b5 = 1.330274429;
                const p = 0.2316419;
                const c = 0.39894228;

                const t = 1 / (1 + p * Math.abs(zScore));
                const zt = c * Math.exp((-zScore * zScore) / 2);
                let percentile = zt * ((((b5 * t + b4) * t + b3) * t + b2) * t + b1) * t;

                percentile = zScore >= 0 ? (1 - percentile) : percentile;
                return percentile * 100;
            }
            // --- End Tweak 3 ---

            
            /**
             * Calculates the Z-Score and Percentile for Adult Head Circumference (HC).
             */
            function calculateCircumference(gender, height, circumference) {
                // Constants are now defined at the top
                let meanHC; 

                // 1. Calculate Expected Mean HC (mu)
                if (gender === 'male') {
                    meanHC = INTERCEPTS.male + (SLOPE * height);
                } else if (gender === 'female') {
                    meanHC = INTERCEPTS.female + (SLOPE * height);
                } else {
                    throw new Error("Invalid gender selected for calculation.");
                }

                // 2. Calculate Z-Score
                const zScore = (circumference - meanHC) / SD;

                // 3. Calculate Percentile (using the new helper function)
                const percentile = zScoreToPercentile(zScore);

                // 4. Determine Interpretation (SIMPLIFIED TEXT)
                let interpretation;
                
                if (zScore > 3.0) { 
                    interpretation = `Z-score is > +3.0 SD. Head circumference is extremely large for stature.`;
                } else if (zScore < -2.0) { 
                    interpretation = `Z-score is < -2.0 SD. Head circumference is significantly small for stature.`;
                } else if (zScore > 2.0) { 
                    interpretation = `Z-score is between +2.0 SD and +3.0 SD. Head circumference is large for stature.`;
                } else if (zScore > 1.5) { 
                    interpretation = `Z-score is between +1.5 SD and +2.0 SD. Head circumference is above the expected average for stature.`;
                } else if (zScore < -1.5) { 
                    interpretation = `Z-score is between -1.5 SD and -2.0 SD. Head circumference is below the expected average for stature.`;
                } else {
                    interpretation = `Z-score is between -1.5 SD and +1.5 SD. Head circumference is within the expected average range for stature.`;
                }
                
                return { zScore, percentile, interpretation, meanHC };
            }

            // --- MAIN FORM SUBMISSION ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                displayMessage("", false); 

                const gender = document.getElementById('gender').value;
                const heightCm = getValidatedHeightCm();
                const circumference = parseFloat(document.getElementById('circumference').value);

                if (!gender || heightCm === null || isNaN(circumference)) {
                    displayMessage(`Please ensure gender is selected, a valid Head Circumference is entered, and height is entered (either in Ft/In or cm) within the 140-200 cm range.`, true);
                    // Hide plot marker if validation fails
                    d3.select("#subject-marker-group").attr("opacity", 0);
                    d3.select("#intersection-lines-group").attr("opacity", 0);
                    return;
                }
                
                try {
                    const { zScore, percentile, interpretation, meanHC } = calculateCircumference(gender, heightCm, circumference);

                    // 1. Display Metrics
                    document.getElementById('mean-output').textContent = meanHC.toFixed(2) + ' cm';
                    document.getElementById('z-score-output').textContent = zScore.toFixed(2);
                    document.getElementById('percentile-output').textContent = `${percentile.toFixed(1)}%`;
                    document.getElementById('interpretation-output').textContent = interpretation;
                    
                    // Set interpretation box style
                    const interpretationBox = document.getElementById('interpretation-box');
                    interpretationBox.className = 'p-4 rounded-lg border';
                    
                    if (zScore > 2.0 || zScore < -2.0) {
                        interpretationBox.classList.add('bg-red-100', 'border-red-300');
                    } else if (zScore > 1.5 || zScore < -1.5) {
                        interpretationBox.classList.add('bg-yellow-100', 'border-yellow-300');
                    } else {
                        interpretationBox.classList.add('bg-green-100', 'border-green-300');
                    }

                    resultsDiv.classList.remove('hidden');

                    // 2. Update and Plot Chart
                    // We must redraw the chart for the new gender/data limits
                    setupChart(gender); 
                    plotSubject(heightCm, circumference, percentile);
                    
                } catch (error) {
                    console.error(error);
                    displayMessage(error.message, true);
                }
            });
            
            // Re-setup chart lines when gender changes
            document.getElementById('gender').addEventListener('change', (e) => {
                 const gender = e.target.value;
                 if (gender) {
                    setupChart(gender);
                 }
                 // Hide plot marker and intersection lines
                 d3.select("#subject-marker-group").attr("opacity", 0);
                 d3.select("#intersection-lines-group").attr("opacity", 0);
            });
            
            // --- DOCUMENTATION TOGGLE ---
            const toggleButton = document.getElementById('toggle-methodology');
            const methodologyContent = document.getElementById('methodology-content');
            const toggleIcon = document.getElementById('toggle-icon');

            toggleButton.addEventListener('click', () => {
                const isHidden = methodologyContent.classList.toggle('hidden');
                toggleIcon.textContent = isHidden ? '+' : 'â€”';
            });
            
            // --- Update documentation text to use 'cm' ---
            document.querySelectorAll('#methodology-content p, #methodology-content li').forEach(el => {
                el.innerHTML = el.innerHTML.replace(/Height in cm/g, 'Height in cm');
                el.innerHTML = el.innerHTML.replace(/SD = 1.41 cm/g, 'SD = 1.41 cm');
            });

        });
    </script>
</body>
</html>
