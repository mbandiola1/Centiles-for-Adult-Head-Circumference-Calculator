<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adult Head Circumference Tool </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.3/jstat.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        /* Chart specific styles */

        .axis text { font-size: 11px; }
        .axis line { stroke: #ccc; }
        .axis path { stroke: #ccc; }

        /* Style for the gridlines */
        .grid line {
            stroke: #d1d5db;
            shape-rendering: crispEdges;
        }
        .grid path {
            stroke-width: 0;
        }

        /* Style for the 'X' marker */
        #subject-marker {
            transition: opacity 0.5s;
        }
        #subject-marker .line {
            stroke: #ef4444;
            stroke-width: 4;
            stroke-linecap: round;
        }
        .intersection-line {
            stroke-dasharray: 4, 2;
            transition: opacity 0.5s;
        }

        /* Style for the background box behind the subject label */
        .label-bg {
            fill: rgba(255, 255, 255, 0.85);
            stroke: #ef4444;
            stroke-width: 1;
            rx: 3;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">

    <div id="app" class="w-full max-w-4xl">

        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-2">
            Adult Head Circumference Centile Tool
        </h1>
        <p class="text-center text-sm text-gray-500 mb-1">
            Calculation and Centile Chart based on
            <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC1793909/" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline font-semibold">
                Bushby et al. (1992) Centiles for adult head circumference.
            </a>
        </p>
        <p class="text-center text-xs text-red-600 mb-8 font-semibold p-1 border border-red-200 bg-red-50 rounded-lg max-w-lg mx-auto">
            Disclaimer: This tool is for reference only and does not provide a definitive clinical diagnosis.
        </p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <div class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-100 h-full">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-6 border-b pb-3">Input Measurements</h2>

                <form id="circumference-form" class="space-y-6">

                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <select id="gender" class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg border" required>
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 gap-6">
                        <div id="height-input-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Height</label>
                            <div class="flex space-x-3">
                                <input type="number" step="1" id="height-ft" min="4" max="7" placeholder="Feet (e.g., 5)" class="block w-1/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                                <input type="number" step="0.1" id="height-in" min="0" max="11.9" placeholder="Inches (e.g., 9)" class="block w-1/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                                <input type="number" step="0.1" id="height-cm" min="140" max="200" placeholder="cm (e.g., 175.5)" class="block w-1/3 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Enter height in Ft/In or cm. Fields will auto-convert. Range: 140-200 cm.</p>
                        </div>

                        <div>
                            <label for="circumference" class="block text-sm font-medium text-gray-700 mb-1">Head Circumference (cm)</label>
                            <input type="number" step="0.1" id="circumference" min="40" max="70" placeholder="e.g., 57.0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                        </div>
                    </div>

                    <button type="submit" id="calculate-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Calculate & Plot
                    </button>
                    <button type="button" id="clear-button" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Clear Form
                    </button>
                </form>
            </div>

            <div class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-100 flex flex-col justify-between">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-3">Centile Chart</h2>
                <div id="chart-container" class="w-full" style="min-height: 350px;">
                    <p id="chart-message" class="text-center text-gray-500 mt-16">Enter measurements above to generate the centile chart.</p>
                </div>
            </div>
        </div>

        <div id="results" class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-100 mt-8 hidden">
            <h2 class="text-2xl font-semibold text-green-700 mb-6 border-b pb-3">Calculated Metrics</h2>

            <div class="space-y-4 grid grid-cols-1 sm:grid-cols-2 gap-4">

                <div class="p-3 bg-gray-50 rounded-lg">
                    <span class="block text-sm font-medium text-gray-700">Expected Mean HC ($\mu$):</span>
                    <span id="mean-output" class="text-xl font-bold text-gray-800">--</span>
                </div>

                <div class="p-4 bg-indigo-100 rounded-lg">
                    <span class="block text-sm font-medium text-indigo-800">Calculated Z-Score:</span>
                    <span id="z-score-output" class="text-2xl font-extrabold text-indigo-800">--</span>
                </div>

                <div class="p-3 bg-gray-50 rounded-lg">
                    <span class="block text-sm font-medium text-gray-700">Percentile Rank:</span>
                    <span id="percentile-output" class="text-xl font-bold text-gray-800">--</span>
                </div>

                <div class="p-4 rounded-lg" id="interpretation-box">
                    <h3 class="text-base font-bold text-gray-800 mb-1">Interpretation:</h3>
                    <p id="interpretation-output" class="text-md font-semibold text-gray-800">--</p>
                </div>
            </div>
        </div>
        
        <div id="calculating-message" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl flex items-center space-x-3">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-lg font-medium text-gray-800">Calculating...</p>
            </div>
        </div>

        <div id="error-message" class="hidden mt-4 p-4 text-sm font-medium text-red-800 rounded-lg bg-red-50 border border-red-200" role="alert">
            </div>

        <div class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-100 mt-8">
            <button id="toggle-methodology" class="w-full py-3 px-4 rounded-lg text-left font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200 transition duration-150 ease-in-out flex justify-between items-center">
                <span>Show Methodology & Documentation</span>
                <span id="toggle-icon">+</span>
            </button>
            <div id="methodology-content" class="mt-4 p-4 border border-gray-200 rounded-lg hidden text-sm">
                <h3 class="text-lg font-bold mb-3">Methodology Report: Adult Head Circumference Centile Tool (Model 1)</h3>

                <p class="mb-3">This tool is based on the linear regression model published in the study: <strong>Bushby et al. (1992)</strong>, assuming a **constant Standard Deviation (\(\sigma\))** as justified by the authors' final analysis.</p>

                <h4 class="text-base font-semibold mb-2 border-b">I. Core Statistical Model</h4>
                <p>The calculation relies on three confirmed parameters extracted from the paper:</p>

                <ol class="list-decimal pl-6 space-y-1 mb-4">
                    <li>**Expected Mean Head Circumference (\(\mu\)):** A gender-specific linear regression equation based on the subject's height.</li>
                    <li>**Standard Deviation (\(\sigma\)):** A constant measure of scatter around the mean line (\(\mathbf{\sigma = 1.41 \text{ cm}}\)).</li>
                    <li>**Z-Score:** The number of standard deviations the subject's measurement falls above or below the mean.</li>
                </ol>

                <h4 class="text-base font-semibold mb-2 border-b">II. The Calculation Steps (Constant SD)</h4>

                <p class="font-bold">Step 1: Calculate the Expected Mean HC (\(\mu\))</p>
                <p class="font-mono bg-gray-100 p-2 rounded-md">
                    $$\mu = 42.4 + (0.08673 \times \text{Height in cm})$$
                </p>
                <p class="font-mono bg-gray-100 mb-4 p-2 rounded-md">
                    $$\mu = 41.02 + (0.08673 \times \text{Height in cm})$$
                </p>

                <p class="font-bold">Step 2: Calculate the Z-Score</p>
                <p>The Z-Score ($Z$) is calculated using the measured HC, the mean $\mu$, and the constant SD ($\sigma$):</p>
                <p class="font-mono bg-gray-100 mb-4 p-2 rounded-md">
                    $$Z = \frac{\text{Measured HC} - \mu}{\sigma}$$
                    $$Z = \frac{\text{Measured HC} - \mu}{1.41}$$
                </p>

                <p class="font-bold">Step 3: Calculate the Centile Rank</p>
                <p class="mb-4">The centile rank (percentile) is derived by converting the Z-score using the highly accurate **Cumulative Distribution Function (\(\Phi\))** of the Standard Normal Distribution: $$P = \Phi(Z) \times 100$$</p>

                <h4 class="text-base font-semibold mb-2 border-b">III. Interpretation Thresholds (Clinical Standard: \(\mathbf{\pm 2.0 \text{ SD}}\))</h4>
                <p class="mb-2">The thresholds below reflect the standard clinical \(\pm 2.0 \text{ SD}\) criteria for abnormality:</p>
                <ul class="list-disc pl-6 space-y-1">
                    <li>**Z \(\mathbf{\geq +2.0 \text{ SD}}\):** Head circumference is **significantly large** for stature (Macrocephaly). (Red)</li>
                    <li>**Z \(\mathbf{< -2.0 \text{ SD}}\):** Head circumference is **significantly small** for stature (Microcephaly). (Red)</li>
                    <li>**Z between \(\mathbf{-2.0 \text{ SD}}\) and \(\mathbf{+2.0 \text{ SD}}\):** Head circumference is **within the expected average range** (Normocephaly). (Green)</li>
                </ul>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('circumference-form');
            const resultsDiv = document.getElementById('results');
            const errorMessageDiv = document.getElementById('error-message');
            const chartContainer = document.getElementById('chart-container');
            const calculatingMessage = document.getElementById('calculating-message');

            const genderInput = document.getElementById('gender');
            const circumferenceInput = document.getElementById('circumference');
            const heightFtInput = document.getElementById('height-ft');
            const heightInInput = document.getElementById('height-in');
            const heightCmInput = document.getElementById('height-cm');
            const clearButton = document.getElementById('clear-button');

            // --- CONSTANTS (Model 1) ---
            const SD = 1.41; // *** Constant Standard Deviation - FIXED ***
            const SLOPE = 0.08673;
            const INTERCEPTS = { male: 42.4, female: 41.02 };
            const Z_SCORES = { 3: -1.88, 10: -1.28, 25: -0.67, 50: 0, 75: 0.67, 90: 1.28, 97: 1.88 };

            // *** CLINICAL THRESHOLD CONSTANTS for JavaScript logic (STRICT +/- 2.0 SD) ***
            const MACRO_RED_Z = 2.0;
            const MICRO_RED_Z = -2.0;
            
            const CM_PER_FOOT = 30.48;
            const CM_PER_INCH = 2.54;

            let isConverting = false;
            
            // ----------------------------------------------------------------------
            // INITIAL SETUP: Clear the form on load & Clear button handler
            // ----------------------------------------------------------------------
            function resetForm() {
                genderInput.value = "";
                circumferenceInput.value = "";
                heightFtInput.value = "";
                heightInInput.value = "";
                heightCmInput.value = "";
                
                resultsDiv.classList.add('hidden');
                errorMessageDiv.classList.add('hidden');
                d3.select("#subject-marker-group").attr("opacity", 0);
                d3.select("#intersection-lines-group").attr("opacity", 0);
                d3.select("#chart-message").text("Enter measurements above to generate the centile chart.");
            }
            
            resetForm(); // Call on load

            // ----------------------------------------------------------------------
            // CONVERSION & VALIDATION FUNCTIONS
            // ----------------------------------------------------------------------

            function convertFtInToCm(ft, inches) {
                return (ft * 12 + inches) * CM_PER_INCH;
            }

            function getValidatedHeightCm() {
                let cm = parseFloat(heightCmInput.value);
                const ft = parseFloat(heightFtInput.value);
                const inches = parseFloat(heightInInput.value);

                if (!isNaN(cm) && cm >= 140 && cm <= 200) {
                    return cm;
                }
                
                if (!isNaN(ft) && !isNaN(inches)) {
                    cm = convertFtInToCm(ft, inches);
                    if (cm >= 140 && cm <= 200) {
                        return cm;
                    }
                }
                
                return null;
            }

            function updateHeightInputs(sourceInput, value) {
                if (isConverting) return;
                isConverting = true;
                
                if (sourceInput === 'cm' && !isNaN(value)) {
                    const totalInches = value / CM_PER_INCH;
                    heightFtInput.value = Math.floor(totalInches / 12);
                    heightInInput.value = (totalInches % 12).toFixed(1);
                } else if ((sourceInput === 'ft' || sourceInput === 'in') && !isNaN(parseFloat(heightFtInput.value)) && !isNaN(parseFloat(heightInInput.value))) {
                    const cm = convertFtInToCm(parseFloat(heightFtInput.value), parseFloat(heightInInput.value));
                    heightCmInput.value = cm.toFixed(1);
                }
                
                isConverting = false;
            }

            // Event listeners for height conversion
            heightCmInput.addEventListener('input', () => updateHeightInputs('cm', parseFloat(heightCmInput.value)));
            heightFtInput.addEventListener('input', () => updateHeightInputs('ft', parseFloat(heightFtInput.value)));
            heightInInput.addEventListener('input', () => updateHeightInputs('in', parseFloat(heightInInput.value)));
            
            // Clear button listener
            clearButton.addEventListener('click', resetForm);

            // ----------------------------------------------------------------------
            // CORE CALCULATION
            // ----------------------------------------------------------------------
            function calculateCircumference(gender, height, circumference) {
                // Step 1: Calculate Expected Mean HC (mu)
                const mu = INTERCEPTS[gender] + (SLOPE * height);

                // Step 2: Calculate Z-Score
                const zScore = (circumference - mu) / SD;

                // Step 3: Calculate Centile Rank
                // jStat.normal.cdf calculates the cumulative distribution function for the standard normal (Z=0, SD=1)
                const percentile = jStat.normal.cdf(zScore, 0, 1) * 100;

                // Step 4: Determine Interpretation (STRICT +/- 2.0 SD)
                let classification = '';
                let interpretationClass = '';
                
                if (zScore >= MACRO_RED_Z) {
                    classification = `Significantly large HC for stature (Macrocephaly).`;
                    interpretationClass = 'bg-red-200 text-red-900';
                } else if (zScore < MICRO_RED_Z) {
                    classification = `Significantly small HC for stature (Microcephaly).`;
                    interpretationClass = 'bg-red-200 text-red-900';
                } else {
                    classification = `Within the expected average range (Normocephaly).`;
                    interpretationClass = 'bg-green-200 text-green-900';
                }
                
                let interpretation = `Z-Score of ${zScore.toFixed(2)} SD (${percentile.toFixed(1)}%). ${classification}`;

                return {
                    mu: mu,
                    zScore: zScore,
                    percentile: percentile,
                    interpretation: interpretation,
                    interpretationClass: interpretationClass
                };
            }

            // ----------------------------------------------------------------------
            // CHART SETUP 
            // ----------------------------------------------------------------------
            let svg, xScale, yScale;
            const margin = { top: 20, right: 25, bottom: 40, left: 50 };
            let width, height;

            function makeXGridlines() { return d3.axisBottom(xScale).ticks(12); }
            function makeYGridlines() { return d3.axisLeft(yScale).ticks(13); }

            function setupChart(gender) {
                chartContainer.innerHTML = '';

                const containerWidth = chartContainer.clientWidth;
                width = containerWidth - margin.left - margin.right;
                height = 400 - margin.top - margin.bottom;

                const xMin = 140; const xMax = 200;
                const yMin = 50; const yMax = 63;

                xScale = d3.scaleLinear().domain([xMin, xMax]).range([0, width]);
                yScale = d3.scaleLinear().domain([yMin, yMax]).range([height, 0]);

                svg = d3.select("#chart-container").append("svg")
                    .attr("viewBox", `0 0 ${containerWidth} 400`).append("g")
                    .attr("transform", `translate(${margin.left}, ${margin.top})`);

                svg.append("g").attr("class", "grid").attr("transform", `translate(0, ${height})`)
                    .call(makeXGridlines().tickSize(-height).tickFormat(""));
                svg.append("g").attr("class", "grid")
                    .call(makeYGridlines().tickSize(-width).tickFormat(""));

                const lineGenerator = d3.line().x(d => xScale(d.height)).y(d => yScale(d.hc));

                // Generate Centile Data Points using CONSTANT SD (Model 1)
                const centileData = Object.entries(Z_SCORES).map(([centile, z]) => {
                    const dataPoints = [];
                    for (let h = xMin; h <= xMax; h += 1) {
                        const meanHC = INTERCEPTS[gender] + (SLOPE * h);
                        // Use constant SD here
                        const hc = meanHC + (z * SD);
                        dataPoints.push({ height: h, hc: hc, centile: centile, z: z });
                    }
                    return dataPoints;
                });

                // Draw Centile Lines
                centileData.forEach(data => {
                    const centile = parseInt(data[0].centile);
                    let strokeColor = '#1f2937';
                    let strokeDash = (centile === 3 || centile === 25 || centile === 75 || centile === 97) ? '8, 4' : '0';
                    svg.append("path").datum(data).attr("d", lineGenerator)
                        .style("fill", "none").style("stroke", strokeColor)
                        .style("stroke-width", "2px").style("stroke-dasharray", strokeDash)
                        .attr("data-centile", centile);
                    svg.append("text").attr("x", xScale(xMax) + 4).attr("y", yScale(data[data.length - 1].hc))
                        .attr("dy", "0.3em").attr("font-size", "10px").attr("font-weight", "bold")
                        .attr("fill", "#6b7280").text(centile);
                });

                // Draw Axes
                svg.append("g").attr("class", "x axis").attr("transform", `translate(0, ${height})`)
                    .call(d3.axisBottom(xScale).ticks(12)).call(g => g.select(".domain").remove());
                svg.append("g").attr("class", "y axis")
                    .call(d3.axisLeft(yScale).ticks(13)).call(g => g.select(".domain").remove());

                // Axis Labels
                svg.append("text").attr("class", "text-sm text-gray-500").attr("text-anchor", "middle")
                    .attr("x", width / 2).attr("y", height + 35).text("Height (cm)");
                svg.append("text").attr("class", "text-sm text-gray-500").attr("text-anchor", "middle")
                    .attr("transform", "rotate(-90)").attr("y", -margin.left + 15).attr("x", -height / 2)
                    .text("Head Circumference (cm)");

                svg.append("g").attr("id", "intersection-lines-group").attr("opacity", 0);

                // Subject Marker Group
                const markerSize = 8;
                const markerGroup = svg.append("g").attr("id", "subject-marker-group").attr("opacity", 0);
                const marker = markerGroup.append("g").attr("id", "subject-marker").attr("transform", "translate(0,0)");
                marker.append("line").attr("class", "line").attr("x1", -markerSize).attr("y1", -markerSize).attr("x2", markerSize).attr("y2", markerSize);
                marker.append("line").attr("class", "line").attr("x1", -markerSize).attr("y1", markerSize).attr("x2", markerSize).attr("y2", -markerSize);
                markerGroup.append("rect").attr("id", "subject-label-bg").attr("class", "label-bg").attr("width", 1).attr("height", 1).attr("x", 0).attr("y", 0);
                markerGroup.append("text").attr("id", "subject-label").attr("font-size", "12px").attr("font-weight", "bold").attr("fill", "#1f2937").attr("text-anchor", "middle");
            }

            function updateIntersectionLines(xPos, yPos, plotHeight) {
                const intersectionLinesGroup = d3.select("#intersection-lines-group");
                intersectionLinesGroup.html("");
                intersectionLinesGroup.append("line").attr("class", "intersection-line")
                    .attr("x1", xPos).attr("y1", plotHeight).attr("x2", xPos).attr("y2", yPos)
                    .style("stroke", "#ef4444").style("stroke-width", 2);
                intersectionLinesGroup.append("line").attr("class", "intersection-line")
                    .attr("x1", 0).attr("y1", yPos).attr("x2", xPos).attr("y2", yPos)
                    .style("stroke", "#ef4444").style("stroke-width", 2);
                intersectionLinesGroup.attr("opacity", 1);
            }

            function plotSubject(heightValue, circumference, percentile) {
                const group = d3.select("#subject-marker-group");
                const label = d3.select("#subject-label");
                const labelBg = d3.select("#subject-label-bg");
                const xPos = xScale(heightValue);
                const yPos = yScale(circumference);

                d3.select("#subject-marker").attr("transform", `translate(${xPos}, ${yPos})`);
                updateIntersectionLines(xPos, yPos, height); // Use global 'height' for plot height

                const labelText = `Your HC (${percentile.toFixed(1)}%)`;
                label.attr("x", xPos).attr("y", yPos - 18).text(labelText);

                const textBBox = label.node().getBBox();
                const padding = 6;
                labelBg.attr("x", textBBox.x - padding / 2).attr("y", textBBox.y - padding / 2)
                    .attr("width", textBBox.width + padding).attr("height", textBBox.height + padding)
                    .attr("opacity", 1);
                group.attr("opacity", 1);
            }

            setupChart('male'); // Initial chart

            window.addEventListener('resize', () => {
                const currentGender = document.getElementById('gender').value || 'male';
                setupChart(currentGender);
                if (!resultsDiv.classList.contains('hidden')) {
                     const gender = document.getElementById('gender').value;
                     const heightValue = getValidatedHeightCm();
                     const circumference = parseFloat(document.getElementById('circumference').value);
                     if (heightValue && !isNaN(circumference)) {
                        const { percentile } = calculateCircumference(gender, heightValue, circumference);
                        plotSubject(heightValue, circumference, percentile);
                     }
                }
            });

            // ----------------------------------------------------------------------
            // FORM SUBMISSION HANDLER
            // ----------------------------------------------------------------------
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                errorMessageDiv.classList.add('hidden');

                const gender = genderInput.value;
                const circumference = parseFloat(circumferenceInput.value);
                const heightValue = getValidatedHeightCm();
                
                if (!gender || isNaN(circumference) || !heightValue) {
                    errorMessageDiv.textContent = "Please ensure a gender, head circumference, and valid height (140-200 cm) are entered.";
                    errorMessageDiv.classList.remove('hidden');
                    resultsDiv.classList.add('hidden');
                    return;
                }

                // Show 'Calculating...' message
                calculatingMessage.classList.remove('hidden');

                // 1. Run Calculation (using a timeout for effect, usually instant)
                setTimeout(() => {
                    const { mu, zScore, percentile, interpretation, interpretationClass } = calculateCircumference(gender, heightValue, circumference);

                    // 2. Update Outputs
                    document.getElementById('mean-output').textContent = `${mu.toFixed(1)} cm`;
                    document.getElementById('z-score-output').textContent = `${zScore.toFixed(2)} SD`;
                    document.getElementById('percentile-output').textContent = `${percentile.toFixed(1)} %`;
                    
                    const interpretationBox = document.getElementById('interpretation-box');
                    document.getElementById('interpretation-output').textContent = interpretation;
                    
                    // Reset class and apply the new one
                    interpretationBox.className = 'p-4 rounded-lg ' + interpretationClass;


                    // 3. Update Chart
                    setupChart(gender);
                    plotSubject(heightValue, circumference, percentile);

                    resultsDiv.classList.remove('hidden');
                    calculatingMessage.classList.add('hidden'); // Hide 'Calculating...'
                }, 100); // Small delay for visual feedback
            });
            
            // --- METHODOLOGY TOGGLE ---
            document.getElementById('toggle-methodology').addEventListener('click', function() {
                const content = document.getElementById('methodology-content');
                const icon = document.getElementById('toggle-icon');
                const isHidden = content.classList.contains('hidden');

                if (isHidden) {
                    content.classList.remove('hidden');
                    icon.textContent = '-';
                } else {
                    content.classList.add('hidden');
                    icon.textContent = '+';
                }
            });

        });
    </script>
</body>
</html>
